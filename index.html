<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#d6001c" />
  <title>Facture Delicella</title>

  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@700;800;900&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root { --primary:#d6001c; --gold:#cfb04a; --dark:#1e293b; --bg:#fff1f1; }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      font-family: 'Nunito', sans-serif;
      background: #555;
      padding: 20px;
      padding-left: 350px; /* desktop */
      display: flex;
      justify-content: center;
      -webkit-text-size-adjust: 100%;
    }

    /* =========================
       ‚úÖ SIDEBAR LEFT (DESKTOP)
       ========================= */
    .sidebar{
      position: fixed;
      top: 20px;
      left: 20px;
      width: 300px;
      z-index: 999;

      display: flex;
      flex-direction: column;
      gap: 36px;
      padding-bottom: 12px;

      opacity: 0;
      transform: translateX(-10px);
      animation: sideIn .55s cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes sideIn{ to{ opacity:1; transform: translateX(0);} }

    .panel, .currency-wrap{ margin-bottom: 8px; }

    .panel{
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.20);
      border-radius: 18px;
      padding: 14px;
      backdrop-filter: blur(12px);
      box-shadow: 0 10px 22px rgba(0,0,0,0.22);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .btn{
      height: 46px;
      width: 100%;
      padding: 0 16px;
      border: none;
      border-radius: 16px;
      font-weight: 900;
      cursor: pointer;
      font-family: 'Lexend';
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 12px 26px rgba(0,0,0,0.20);
      transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
      touch-action: manipulation;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 16px 34px rgba(0,0,0,0.26); filter: brightness(1.03); }
    .btn:active{ transform: translateY(0px); }

    .btn-clients{ background:#111827; color:#fff; }
    .btn-saveinfo{ background: var(--gold); color:#1e293b; }
    .btn-add{ background: var(--gold); color:#1e293b; }
    .btn-pdf{ background: var(--primary); color:#fff; }

    /* =========================
       ‚úÖ Devise & TVA (DESKTOP)
       ========================= */
    .currency-wrap{ position: relative; width: 100%; height: 46px; }

    .currency-fab{
      width: 100%;
      height: 46px;
      border-radius: 14px;
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(255,255,255,0.35);
      box-shadow: 0 12px 26px rgba(0,0,0,0.22);
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 0 14px;
      cursor: pointer;
      user-select:none;
      transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
      touch-action: manipulation;
    }
    .currency-fab:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 34px rgba(0,0,0,0.26);
      filter: brightness(1.02);
    }

    .fab-top{
      display:flex;
      align-items:center;
      gap: 10px;
      font-family: 'Lexend';
      font-weight: 900;
      font-size: 0.72rem;
      letter-spacing: 1px;
      color:#64748b;
      text-transform: uppercase;
      white-space: nowrap;
    }
    .fab-dot{
      width:10px; height:10px; border-radius:50%;
      background: var(--primary);
      box-shadow: 0 0 0 4px rgba(214,0,28,0.12);
      flex: 0 0 auto;
    }
    .fab-bottom{
      font-family:'Lexend';
      font-weight: 900;
      font-size: 0.85rem;
      color:#0f172a;
      white-space: nowrap;
    }

    .currency-menu{
      position: absolute;
      left: calc(100% + 12px);
      top: 0;
      width: 230px;
      background: rgba(255,255,255,0.96);
      border: 1px solid rgba(148,163,184,0.35);
      border-radius: 18px;
      box-shadow: 0 22px 60px rgba(0,0,0,0.30);
      backdrop-filter: blur(14px);
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr 80px;
      gap: 10px;
      align-items: center;

      opacity: 0;
      transform: translateX(-6px);
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 1200;
    }

    .currency-wrap:hover .currency-menu{
      opacity: 1;
      transform: translateX(0);
      pointer-events: auto;
    }

    /* ‚úÖ MOBILE: hover ŸÖÿßŸÉŸäÿÆÿØŸÖÿ¥ÿå ÿ∫ÿßÿØŸä ŸÜÿ™ÿ≠ŸÉŸÖŸà ÿ®ÿßŸÑŸÄ class .open ŸÖŸÜ JS */
    .currency-wrap.open .currency-menu{
      opacity: 1;
      transform: translateX(0);
      pointer-events: auto;
    }

    .currency-menu select, .currency-menu input{
      height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.12);
      padding: 0 12px;
      font-size: 0.92rem;
      font-weight: 900;
      outline: none;
      background: rgba(255,255,255,0.98);
    }
    .currency-menu input{ text-align:center; }

    /* =========================
       ‚úÖ Page A4 + responsive scale
       ========================= */
    .page-a4{
      width: 210mm;
      min-height: 296mm;
      background: white;
      position: relative;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      padding: 0;
      overflow: hidden;
      z-index: 1;
      margin-top: 0;
      transform-origin: top center;
    }

    .watermark-container{
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: flex; justify-content: center; align-items: center;
      z-index: 0; opacity: 0.08; pointer-events: none;
    }
    .watermark-container img{ width: 75%; height: auto; }

    .header, .body, .footer{ position: relative; z-index: 2; }

    .header{
      background: rgba(255, 241, 241, 0.85);
      padding: 21px 40px 10px 40px;
      border-bottom: 4px solid var(--gold);
      display: flex; justify-content: space-between; align-items: flex-start;
    }
    .header-left{ display: flex; flex-direction: column; }
    .title{
      font-family: 'Lexend';
      font-size: 4.2rem;
      color: var(--primary);
      margin: 0;
      line-height: 1;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-left: 20px;
    }
    .meta{ margin-top: 40px; display: flex; flex-direction: column; gap: 10px; }
    .meta-row{ display: flex; align-items: center; gap: 10px; font-weight: 800; color: var(--dark); }
    .meta-row span{ color: var(--primary); font-family: 'Lexend'; font-size: 0.9rem; }
    .meta-row input{
      background: transparent;
      border: none;
      font-weight: 800;
      font-size: 1.1rem;
      color: var(--dark);
      width: 140px;
      cursor: pointer;
      outline: none;
    }
    .logo-box img{ height: 250px; width: auto; margin-top: -50px; }

    .body{ padding: 25px 40px 25px 40px; flex: 1; display: flex; flex-direction: column; }

    .grid{ display: grid; grid-template-columns: 0.6fr 1.4fr; gap: 0; margin-bottom: 35px; }
    .grid > div:first-child{ border-right: 3px solid var(--gold); padding-right: 25px; }
    .client-section{ padding-left: 25px; }

    .box-title{
      color: #000;
      font-family: 'Nunito', sans-serif;
      font-size: 0.85rem;
      font-weight: 800;
      display: inline-block;
      padding-bottom: 6px;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
      line-height: 1;
      border-bottom: none !important;
      box-shadow: inset 0 -3px 0 var(--primary);
    }

    .company-info{ font-size: 0.95rem; line-height: 1.5; color: var(--dark); }

    .input-group{ display: flex; align-items: flex-start; margin-bottom: 8px; border-bottom: 1px dashed #ccc; padding-bottom: 2px; }
    .input-group label{
      font-weight: 700; color: var(--dark); font-size: 0.85rem;
      min-width: 145px; font-family: 'Lexend'; padding-top: 5px; text-transform: uppercase;
    }
    .input-group input{ flex: 1; border: none; background: transparent; font-weight: 600; font-size: 0.95rem; color: #000; padding: 5px 0 5px 10px; outline:none; }

    .flow-box{ border-bottom: 1px dashed #ccc; margin-bottom: 8px; padding-bottom: 5px; cursor: text; display: block; }
    .flow-box label{ font-weight: 700; color: var(--dark); font-size: 0.85rem; font-family: 'Lexend'; text-transform: uppercase; display: inline; margin-right: 5px; }
    .flow-content{ display: inline; font-weight: 600; font-size: 0.95rem; color: #000; outline: none; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; }
    .flow-content:empty:before{ content: '...'; color: #aaa; font-weight: 400; }

    .phone-wrapper{ display: flex; align-items: center; flex: 1; }
    .phone-select{ border: none; background: transparent; font-weight: 800; font-size: 0.9rem; color: var(--primary); cursor: pointer; margin-right: 8px; outline: none; }
    .phone-input{ flex:1; border:none; background:transparent; font-weight:600; font-size:0.95rem; color:#000; outline:none; padding: 5px 0 5px 10px; }

    table{ width: 100%; border-collapse: collapse; margin-top: 10px; }
    th{
      text-align:left;
      padding:8px 5px;
      color:var(--primary);
      font-family:'Lexend';
      font-size:0.85rem;
      border-bottom: none !important;
      box-shadow: none !important;
    }
    thead{ position: relative; }
    thead::after{
      content:"";
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      height:2px;
      background: var(--primary);
    }
    td{ padding: 8px 5px; border-bottom: 1px solid #f0f0f0; }
    td input{ width: 100%; border: none; font-weight: 700; font-size: 0.95rem; background: transparent; outline:none; }

    .delete-btn{
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--primary);
      font-weight: 900;
      font-size: 1.1rem;
      padding: 2px 6px;
      border-radius: 6px;
      line-height: 1;
    }
    .delete-btn:hover{ background: rgba(214,0,28,0.10); }

    .totals-section{ display: flex; justify-content: flex-end; margin-top: 30px; }
    .totals-box{ width: 240px; background: transparent; padding: 10px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05); }
    .row{ display: flex; justify-content: space-between; padding: 6px 0; font-weight: 700; color: #64748b; font-size: 0.9rem; }
    .row.final{ color: var(--primary); font-size: 1.1rem; border-top: 2px solid var(--primary); margin-top: 5px; padding-top: 5px; font-family: 'Lexend'; }

    .payment-section{ margin-top: 40px; display: flex; justify-content: flex-start; }
    .payment-box{ font-size: 0.9rem; color: var(--dark); background: rgba(255, 241, 241, 0.4); padding: 15px; border-radius: 8px; border-left: 3px solid var(--gold); min-width: 300px; }
    .payment-title{ font-family: 'Lexend'; font-weight: 800; color: var(--primary); text-transform: uppercase; margin-bottom: 5px; font-size: 0.95rem; display: inline-block; border-bottom: 2px solid var(--gold); padding-bottom: 2px; }
    .payment-details{ line-height: 1.6; margin-top: 5px; }
    .bank-info{ font-weight: 800; color: #000; font-size: 1rem; }

    .footer{ padding: 15px 40px; border-top: 2px solid var(--gold); font-size: 0.75rem; color: #94a3b8; display: flex; justify-content: space-between; font-weight: 700; margin-top: auto; }

    .no-print{ display:block; }

    /* ‚úÖ Modal clients (ŸÜŸÅÿ≥ ÿØŸäÿßŸÑŸÉ) */
    .modal-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 18px; }
    .modal-backdrop.open{ display:flex; }
    .modal{ width: min(980px, 96vw); height: min(620px, 86vh); background: rgba(255,255,255,0.94); border: 1px solid rgba(255,255,255,0.30); border-radius: 22px; box-shadow: 0 25px 80px rgba(0,0,0,0.35); backdrop-filter: blur(14px); overflow: hidden; }
    .modal-header{ display:flex; align-items:center; justify-content: space-between; padding: 18px 22px; background: rgba(248,250,252,0.85); border-bottom: 1px solid rgba(15,23,42,0.08); }
    .modal-title{ font-family: 'Lexend'; font-weight: 900; color: var(--primary); font-size: 1.55rem; }
    .modal-search{ display:flex; align-items:center; gap: 10px; background: rgba(255,255,255,0.9); border: 1px solid rgba(148,163,184,0.35); border-radius: 999px; padding: 10px 14px; width: min(420px, 50vw); }
    .modal-search i{ color:#94a3b8; }
    .modal-search input{ border:none; outline:none; background: transparent; width: 100%; font-weight: 700; font-size: 0.95rem; }
    .modal-close{ border:none; background: transparent; font-size: 1.35rem; font-weight: 900; cursor:pointer; color:#0f172a; width: 42px; height: 42px; border-radius: 12px; }
    .modal-close:hover{ background: rgba(15,23,42,0.08); }
    .modal-body{ padding: 18px; height: calc(100% - 76px); overflow: auto; }
    .clients-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
    .client-card{ background: rgba(255,255,255,0.92); border: 1px solid rgba(148,163,184,0.30); border-radius: 18px; padding: 16px; box-shadow: 0 14px 30px rgba(0,0,0,0.10); display:flex; flex-direction: column; gap: 10px; min-height: 170px; }
    .client-card:hover{ transform: translateY(-2px); transition: .15s; }
    .avatar{ width: 46px; height: 46px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-family: 'Lexend'; font-weight: 900; color: #fff; background: var(--primary); }
    .client-name{ font-family:'Lexend'; font-weight: 900; color:#0f172a; font-size: 1.05rem; }
    .client-line{ display:flex; align-items:center; gap: 10px; color:#64748b; font-weight: 800; font-size: 0.92rem; }
    .client-line i{ color:#94a3b8; width: 16px; text-align:center; }
    .card-actions{ margin-top: 6px; display:flex; align-items:center; gap: 10px; }
    .choose-btn{ flex: 1; height: 38px; border-radius: 12px; border:none; background:#111827; color:#fff; font-family:'Lexend'; font-weight: 900; cursor:pointer; touch-action: manipulation; }
    .trash-btn{ width: 42px; height: 38px; border-radius: 12px; border:none; cursor:pointer; background: rgba(239,68,68,0.12); color: #ef4444; font-size: 1.05rem; touch-action: manipulation; }
    .empty-state{ padding: 30px; text-align:center; color:#64748b; font-weight: 900; background: rgba(255,255,255,0.7); border: 1px dashed rgba(148,163,184,0.5); border-radius: 18px; }

    /* =========================
       ‚úÖ MOBILE RESPONSIVE
       ========================= */
    @media (max-width: 980px){
      body{
        padding: 14px !important;
        padding-top: 308px !important; /* ŸÖŸÉÿßŸÜ sidebar */
        padding-left: 14px !important;
        display:block;
      }

      .sidebar{
        position: fixed;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        width: min(560px, calc(100vw - 24px));
        gap: 12px;
      }

      .currency-wrap{ height: 46px; }

      .currency-menu{
        left: 0;
        top: 56px;
        width: 100%;
      }

      /* ‚úÖ ÿÆŸÑŸäŸá responsive ŸàŸäÿµÿ∫ÿ± ŸÖÿπ ÿßŸÑÿ¥ÿßÿ¥ÿ© */
      .page-a4{
        width: 210mm;
        margin: 0 auto;
      }

      /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿµÿ∫ÿßÿ± ŸÑŸÑŸÖŸàÿ®ÿßŸäŸÑ */
      .header{ padding: 18px 18px 10px 18px; }
      .body{ padding: 18px; }
      .logo-box img{ height: 150px; margin-top: -20px; }
      .title{ font-size: 3rem; margin-left: 10px; }
      .meta{ margin-top: 18px; }
      .grid{ grid-template-columns: 1fr; }
      .grid > div:first-child{ border-right: none; padding-right: 0; border-bottom: 3px solid var(--gold); padding-bottom: 14px; }
      .client-section{ padding-left: 0; padding-top: 14px; }
      .payment-box{ min-width: 100%; }
      .footer{ padding: 12px 18px; flex-direction: column; gap: 6px; }
    }

    /* ‚úÖ Very small phones */
    @media (max-width: 420px){
      body{ padding-top: 318px !important; }
      .title{ font-size: 2.5rem; }
      .logo-box img{ height: 130px; }
      .totals-box{ width: 100%; }
      .totals-section{ justify-content: stretch; }
    }
  </style>
</head>

<body>

  <div class="sidebar no-print">
    <div class="panel">
      <button class="btn btn-clients" id="openClients">
        <i class="fa-solid fa-users"></i>
        Clients Enregistr√©s
      </button>

      <button class="btn btn-saveinfo" id="saveClient">
        <i class="fa-solid fa-floppy-disk"></i>
        Sauvegarder Info
      </button>
    </div>

    <div class="currency-wrap" id="currencyWrap">
      <div class="currency-fab" id="currencyFab" title="Devise & TVA">
        <div class="fab-top">
          <span class="fab-dot"></span>
          <span>TVA / DEVISE</span>
        </div>
        <div class="fab-bottom">
          <span id="curPreview">MAD</span> ‚Ä¢ <span id="tvaPreview">20%</span>
        </div>
      </div>

      <div class="currency-menu" id="currencyMenu">
        <select id="currency" onchange="calc(); updatePreview()">
          <option value="MAD" selected>MAD</option>
          <option value="EUR">EUR</option>
          <option value="USD">USD</option>
        </select>
        <input id="tvaRate" type="number" value="20" min="0" step="0.1" oninput="calc(); updatePreview()" />
      </div>
    </div>

    <div class="panel">
      <button class="btn btn-add" onclick="addLine()">
        <i class="fa-solid fa-plus"></i>
        Ajouter Ligne
      </button>

      <button class="btn btn-pdf btn-pdf-main" onclick="downloadPDF()">
        <i class="fa-solid fa-file-pdf"></i>
        T√©l√©charger PDF
      </button>
    </div>
  </div>

  <!-- ‚úÖ MODAL CLIENTS -->
  <div class="modal-backdrop" id="clientsModalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="clientsTitle">
      <div class="modal-header">
        <div class="modal-title" id="clientsTitle">Mes Clients</div>
        <div class="modal-search">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input id="clientSearch" type="text" placeholder="Rechercher..." />
        </div>
        <button class="modal-close" id="closeClients" title="Fermer">√ó</button>
      </div>
      <div class="modal-body">
        <div class="clients-grid" id="clientsGrid"></div>
        <div class="empty-state" id="clientsEmpty" style="display:none;">Aucun client enregistr√© pour le moment.</div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ INVOICE -->
  <div class="page-a4" id="invoice">
    <div class="watermark-container">
      <img src="data:image/png;base64,....(CODE-WATERMARK-HNA)...." alt="Watermark">
    </div>

    <div class="header">
      <div class="header-left">
        <h1 class="title">FACTURE</h1>
        <div class="meta">
          <div class="meta-row"><span>DATE:</span> <input type="text" id="date" placeholder="S√©lectionner..."></div>
          <div class="meta-row"><span>N¬∞ FACTURE:</span> <input type="text" id="invoiceNum"></div>
        </div>
      </div>
      <div class="logo-box">
        <img src="data:image/png;base64,....(CODE-LOGO-HNA)...." alt="Logo">
      </div>
    </div>

    <div class="body">
      <div class="grid">
        <div>
          <span class="box-title">√âMETTEUR</span>
          <div class="company-info">
            <strong style="color:var(--primary); font-family:'Lexend'; font-size:1.1rem;">DELICELLA SARL AU</strong><br>
            4, Rue Oued Ziz, 3√®me √âtage<br>Appt. 7, Agdal<br>
            +212 642-395388
          </div>
        </div>

        <div class="client-section">
          <span class="box-title">DESTINATAIRE</span>

          <div class="input-group">
            <label>Nom du client :</label>
            <input type="text" id="c_name" placeholder="...">
          </div>

          <div class="flow-box" onclick="this.querySelector('.flow-content').focus()">
            <label>Soci√©t√© Nom :</label>
            <span class="flow-content" id="c_company" contenteditable="true"></span>
          </div>

          <div class="flow-box" onclick="this.querySelector('.flow-content').focus()">
            <label>ICE :</label>
            <span class="flow-content" id="c_ice" contenteditable="true"></span>
          </div>

          <div class="flow-box" onclick="this.querySelector('.flow-content').focus()">
            <label>Adresse :</label>
            <span class="flow-content" id="c_address" contenteditable="true"></span>
          </div>

          <div class="input-group">
            <label>N¬∞ T√©l√©phone :</label>
            <div class="phone-wrapper">
              <select class="phone-select" id="c_phone_code">
                <option value="+212">üá≤üá¶ +212</option>
                <option value="+33">üá´üá∑ +33</option>
                <option value="+1">üá∫üá∏ +1</option>
                <option value="+34">üá™üá∏ +34</option>
                <option value="+971">üá¶üá™ +971</option>
              </select>
              <input class="phone-input" type="text" id="c_phone" placeholder="6 00 00 00 00">
            </div>
          </div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th width="45%">D√âSIGNATION</th>
            <th width="10%" style="text-align:center">QT√â</th>
            <th width="15%" style="text-align:right">P.U</th>
            <th width="20%" style="text-align:right">TOTAL</th>
            <th width="10%" class="no-print"></th>
          </tr>
        </thead>
        <tbody id="lines"></tbody>
      </table>

      <div class="totals-section">
        <div class="totals-box">
          <div class="row"><span>TOTAL HT</span> <span id="tht">0.00</span></div>
          <div class="row"><span id="tvaLabel">TVA (20%)</span> <span id="tva">0.00</span></div>
          <div class="row final"><span>TOTAL TTC</span> <span id="ttc">0.00</span></div>
        </div>
      </div>

      <div class="payment-section">
        <div class="payment-box">
          <div class="payment-title">R√àGLEMENT :</div>
          <div style="margin-bottom:5px; font-size:0.8rem; font-weight:700;">Par virement bancaire :</div>
          <div class="payment-details">
            <div style="margin-bottom:4px;">Banque : <span class="bank-info" contenteditable="true">BMCE BANK</span></div>
            <div>RIB : <span class="bank-info" contenteditable="true">MA64 0118 1500 0011 2100 0094 4504</span></div>
          </div>
        </div>
      </div>

    </div>

    <div class="footer">
      <div>ICE: 003709007000096 | RC: 185955</div>
      <div>E-mail : contact@delicella.ma</div>
    </div>
  </div>

  <datalist id="produits-list">
    <option value="SAHARA DELICE 700G">
    <option value="SAHARA DELICE 350G">
  </datalist>

  <script>
    const currencySymbols = { MAD: "DH", EUR: "‚Ç¨", USD: "$" };

    function isMobile(){
      return window.matchMedia("(max-width: 980px)").matches;
    }

    function updateInvoiceScale(){
      const invoice = document.getElementById("invoice");
      if(!invoice) return;

      // A4 width in px (approx at 96dpi): 210mm ~ 794px
      const targetWidth = 794;
      const available = Math.min(window.innerWidth - 28, 980); // padding safe
      const scale = Math.min(1, available / targetWidth);

      invoice.style.transform = `scale(${scale})`;
      invoice.style.marginBottom = (scale < 1 ? (targetWidth * (1-scale) * 0.6) : 0) + "px";
    }

    window.addEventListener("resize", updateInvoiceScale);

    window.onload = () => {
      flatpickr("#date", { locale:"fr", dateFormat:"d/m/Y", defaultDate:"today", animate:true, disableMobile:true });
      document.getElementById('invoiceNum').value = Math.floor(10000 + Math.random() * 90000);

      addLine(); addLine();
      updatePreview();
      calc();
      renderClients();

      updateInvoiceScale();
      setupCurrencyToggleMobile();
    };

    function setupCurrencyToggleMobile(){
      const wrap = document.getElementById("currencyWrap");
      const fab = document.getElementById("currencyFab");

      // ŸÅÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ: click ÿ®ÿßÿ¥ ŸäŸÅÿ™ÿ≠ menu
      fab.addEventListener("click", (e) => {
        if(!isMobile()) return; // desktop hover ŸÉÿßŸÅŸä
        e.stopPropagation();
        wrap.classList.toggle("open");
      });

      // click ÿÆÿßÿ±ÿ¨ menu Ÿäÿ≥ÿØŸà
      document.addEventListener("click", (e) => {
        if(!isMobile()) return;
        if(!wrap.contains(e.target)) wrap.classList.remove("open");
      });

      // ŸÖŸÜÿπ ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ ŸÖŸÑŸä ŸÉÿ™ÿ∂ÿ∫ÿ∑ ÿØÿßÿÆŸÑ menu
      document.getElementById("currencyMenu").addEventListener("click", (e) => e.stopPropagation());
    }

    function updatePreview(){
      const cur = document.getElementById("currency").value || "MAD";
      const tva = parseFloat(document.getElementById("tvaRate").value);
      document.getElementById("curPreview").innerText = cur;
      document.getElementById("tvaPreview").innerText = (isNaN(tva) ? 20 : tva) + "%";
    }

    function getCurrencySymbol(){
      const cur = document.getElementById('currency')?.value || "MAD";
      return currencySymbols[cur] || "DH";
    }
    function getTvaRate(){
      const v = parseFloat(document.getElementById('tvaRate')?.value);
      return isNaN(v) ? 20 : v;
    }

    function addLine() {
      const sym = getCurrencySymbol();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" list="produits-list" placeholder="Article ou Service..."></td>
        <td><input class="qty" type="number" value="1" style="text-align:center" oninput="calc()"></td>
        <td><input class="pu" type="number" placeholder="0.00" style="text-align:right" oninput="calc()"></td>
        <td style="text-align:right; font-weight:800; color:#1e293b">0.00 ${sym}</td>
        <td class="no-print" style="text-align:right;">
          <button class="delete-btn" type="button" onclick="removeLine(this)" title="Supprimer">‚úñ</button>
        </td>
      `;
      document.getElementById('lines').appendChild(tr);
      calc();
    }

    function removeLine(btn){
      const row = btn.closest('tr');
      if(row) row.remove();
      calc();
    }

    function calc() {
      const sym = getCurrencySymbol();
      const rate = getTvaRate();
      document.getElementById('tvaLabel').innerText = `TVA (${rate}%)`;

      let total = 0;
      document.querySelectorAll('#lines tr').forEach(row => {
        const q = parseFloat(row.querySelector('.qty')?.value) || 0;
        const p = parseFloat(row.querySelector('.pu')?.value) || 0;
        const t = q * p;
        row.cells[3].innerText = t.toFixed(2) + " " + sym;
        total += t;
      });

      const tva = total * (rate / 100);
      const ttc = total + tva;

      document.getElementById('tht').innerText = total.toFixed(2) + " " + sym;
      document.getElementById('tva').innerText = tva.toFixed(2) + " " + sym;
      document.getElementById('ttc').innerText = ttc.toFixed(2) + " " + sym;
    }

    function downloadPDF() {
      const element = document.getElementById('invoice');
      const btn = document.querySelector('.btn-pdf-main');
      const oldHTML = btn.innerHTML;
      btn.innerHTML = "‚è≥ G√©n√©ration...";

      const mobile = window.innerWidth < 600;
      const opt = {
        margin: 0,
        filename: 'Facture_Delicella.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
          scale: mobile ? 1.35 : 2,
          useCORS: true,
          scrollY: 0,
          ignoreElements: (el) => el.classList?.contains('no-print')
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().from(element).set(opt).save().then(() => {
        btn.innerHTML = oldHTML;
      }).catch(err => {
        alert("Erreur: " + err);
        btn.innerHTML = oldHTML;
      });
    }

    /* =========================
       ‚úÖ Clients localStorage (ŸÜŸÅÿ≥ ÿØŸäÿßŸÑŸÉ)
       ========================= */
    const STORAGE_KEY = "delicella_clients_v1";

    function loadClients(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); } catch(e){ return []; } }
    function saveClients(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

    function getClientFromForm(){
      const name = (document.getElementById("c_name").value || "").trim();
      const company = (document.getElementById("c_company").innerText || "").trim();
      const ice = (document.getElementById("c_ice").innerText || "").trim();
      const address = (document.getElementById("c_address").innerText || "").trim();
      const phoneCode = document.getElementById("c_phone_code").value || "+212";
      const phone = (document.getElementById("c_phone").value || "").trim();
      return { name, company, ice, address, phoneCode, phone };
    }

    function fillFormWithClient(c){
      document.getElementById("c_name").value = c.name || "";
      document.getElementById("c_company").innerText = c.company || "";
      document.getElementById("c_ice").innerText = c.ice || "";
      document.getElementById("c_address").innerText = c.address || "";
      document.getElementById("c_phone_code").value = c.phoneCode || "+212";
      document.getElementById("c_phone").value = c.phone || "";
    }

    function clientKey(c){
      return ((c.phoneCode||"") + (c.phone||"")).replace(/\s/g,"") || ((c.name||"") + "|" + (c.company||"")).toLowerCase();
    }

    function saveCurrentClient(){
      const c = getClientFromForm();
      if(!c.name && !c.company){ alert("ÿØÿÆŸÑ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ Nom du client ŸàŸÑÿß Soci√©t√© Nom ŸÇÿ®ŸÑ ÿßŸÑÿ≠ŸÅÿ∏."); return; }

      const list = loadClients();
      const k = clientKey(c);
      const idx = list.findIndex(x => clientKey(x) === k);

      if(idx >= 0) list[idx] = { ...list[idx], ...c, updatedAt: Date.now() };
      else list.unshift({ ...c, id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()), createdAt: Date.now() });

      saveClients(list);
      renderClients();
      toast("‚úÖ Client sauvegard√©");
    }

    function deleteClient(id){
      const list = loadClients().filter(c => c.id !== id);
      saveClients(list);
      renderClients();
    }

    const modalBackdrop = document.getElementById("clientsModalBackdrop");
    const openClientsBtn = document.getElementById("openClients");
    const closeClientsBtn = document.getElementById("closeClients");
    const saveClientBtn = document.getElementById("saveClient");
    const searchInput = document.getElementById("clientSearch");

    openClientsBtn.addEventListener("click", () => {
      modalBackdrop.classList.add("open");
      searchInput.value = "";
      renderClients();
      setTimeout(() => searchInput.focus(), 80);
    });
    closeClientsBtn.addEventListener("click", () => modalBackdrop.classList.remove("open"));
    modalBackdrop.addEventListener("click", (e) => { if(e.target === modalBackdrop) modalBackdrop.classList.remove("open"); });
    document.addEventListener("keydown", (e) => { if(e.key === "Escape") modalBackdrop.classList.remove("open"); });

    saveClientBtn.addEventListener("click", saveCurrentClient);
    searchInput.addEventListener("input", renderClients);

    function renderClients(){
      const grid = document.getElementById("clientsGrid");
      const empty = document.getElementById("clientsEmpty");
      const q = (searchInput?.value || "").trim().toLowerCase();

      const list = loadClients().filter(c => {
        if(!q) return true;
        const hay = `${c.name||""} ${c.company||""} ${c.address||""} ${c.phoneCode||""} ${c.phone||""} ${c.ice||""}`.toLowerCase();
        return hay.includes(q);
      });

      grid.innerHTML = "";
      if(list.length === 0){ empty.style.display = "block"; return; }
      empty.style.display = "none";

      list.forEach(c => {
        const letter = ((c.name || c.company || "?").trim()[0] || "?").toUpperCase();
        const card = document.createElement("div");
        card.className = "client-card";
        card.innerHTML = `
          <div style="display:flex; gap:12px; align-items:center;">
            <div class="avatar">${letter}</div>
            <div style="min-width:0;">
              <div class="client-name">${escapeHtml(c.name || c.company || "Client")}</div>
              <div style="color:#94a3b8; font-weight:900; font-size:0.82rem; margin-top:2px;">
                ${escapeHtml(c.company || "")}
              </div>
            </div>
          </div>

          <div class="client-line"><i class="fa-solid fa-location-dot"></i><span>${escapeHtml(c.address || "‚Äî")}</span></div>
          <div class="client-line"><i class="fa-solid fa-phone"></i><span>${escapeHtml(((c.phoneCode||"") + " " + (c.phone||"")).trim() || "‚Äî")}</span></div>

          <div class="card-actions">
            <button class="choose-btn" type="button">CHOISIR</button>
            <button class="trash-btn" type="button" title="Supprimer"><i class="fa-solid fa-trash"></i></button>
          </div>
        `;

        card.querySelector(".choose-btn").addEventListener("click", () => {
          fillFormWithClient(c);
          modalBackdrop.classList.remove("open");
          toast("‚úÖ Client s√©lectionn√©");
        });

        card.querySelector(".trash-btn").addEventListener("click", () => {
          if(confirm("Supprimer ce client ?")) deleteClient(c.id);
        });

        grid.appendChild(card);
      });
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    let toastTimer = null;
    function toast(msg){
      let t = document.getElementById("toastBox");
      if(!t){
        t = document.createElement("div");
        t.id = "toastBox";
        t.style.cssText = `
          position: fixed; left: 50%; bottom: 22px; transform: translateX(-50%);
          background: rgba(17,24,39,0.92); color: #fff;
          padding: 12px 16px; border-radius: 14px;
          font-family: 'Lexend'; font-weight: 900; font-size: 0.9rem;
          box-shadow: 0 18px 50px rgba(0,0,0,0.35);
          z-index: 5000; opacity: 0; transition: opacity .18s ease, transform .18s ease;
        `;
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.style.opacity = "1";
      t.style.transform = "translateX(-50%) translateY(-2px)";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        t.style.opacity = "0";
        t.style.transform = "translateX(-50%) translateY(6px)";
      }, 1400);
    }
  </script>
</body>
</html>
