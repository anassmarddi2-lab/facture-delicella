<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Facture Delicella - Mobile Fixed</title>

  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@700;800;900&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{--primary:#d6001c;--gold:#cfb04a;--dark:#1e293b;--bg:#fff1f1}

    body{
      font-family:'Nunito',sans-serif;
      background:#555;
      padding:20px;
      padding-left:350px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
      margin: 0;
      /* Scroll smooth */
      overflow-x: hidden;
    }

    /* Sidebar */
    .sidebar{
      position:fixed;top:20px;left:20px;width:300px;z-index:999;
      display:flex;flex-direction:column;gap:18px;padding-bottom:12px;
      opacity:0;transform:translateX(-10px);
      animation:sideIn .55s cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes sideIn{to{opacity:1;transform:translateX(0)}}

    .panel,.currency-wrap{margin-bottom:8px}
    .panel{
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.20);
      border-radius:18px;padding:14px;
      backdrop-filter:blur(12px);
      box-shadow:0 10px 22px rgba(0,0,0,.22);
      display:flex;flex-direction:column;gap:14px;
    }

    .btn{
      height:46px;width:100%;padding:0 16px;border:none;border-radius:16px;
      font-weight:900;cursor:pointer;font-family:'Lexend';white-space:nowrap;
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      box-shadow:0 12px 26px rgba(0,0,0,.20);
      transition:transform .15s ease,box-shadow .15s ease,filter .15s ease;
      -webkit-tap-highlight-color:transparent;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 16px 34px rgba(0,0,0,.26);filter:brightness(1.03)}
    .btn:active{transform:translateY(0)}

    .btn-clients{background:#111827;color:#fff}
    .btn-history{background:#475569;color:#fff}
    .btn-saveinfo{background:var(--gold);color:#1e293b}
    .btn-add{background:var(--gold);color:#1e293b}
    .btn-pdf{background:var(--primary);color:#fff}

    /* TVA / DEVISE Button Fix */
    .currency-wrap{
      position:relative; width:100%; height:46px; display: flex; justify-content: center;
    }
    .currency-fab{
      width: 94%; max-width: 280px; height:46px; border-radius:14px;
      background:rgba(255,255,255,.92); border:1px solid rgba(255,255,255,.35);
      box-shadow:0 12px 26px rgba(0,0,0,.22); display:flex; align-items:center; justify-content:space-between;
      padding:0 14px; cursor:pointer; user-select:none; margin: 0 auto;
      transition:transform .15s ease,box-shadow .15s ease,filter .15s ease;
      -webkit-tap-highlight-color:transparent;
    }
    .currency-fab:hover{transform:translateY(-1px);box-shadow:0 16px 34px rgba(0,0,0,.26);filter:brightness(1.02)}
    
    .fab-top{display:flex;align-items:center;gap:10px;font-family:'Lexend';font-weight:900;font-size:.72rem;letter-spacing:1px;color:#64748b;text-transform:uppercase;white-space:nowrap}
    .fab-dot{width:10px;height:10px;border-radius:50%;background:var(--primary);box-shadow:0 0 0 4px rgba(214,0,28,.12);flex:0 0 auto}
    .fab-bottom{font-family:'Lexend';font-weight:900;font-size:.85rem;color:#0f172a;white-space:nowrap}

    .currency-menu{
      position:absolute; left: 50%; transform: translateX(-50%) translateY(10px); top: 46px;
      width: 280px; max-width: 90vw; background:rgba(255,255,255,.96);
      border:1px solid rgba(148,163,184,.35); border-radius:18px;
      box-shadow:0 22px 60px rgba(0,0,0,.30); backdrop-filter:blur(14px);
      padding:12px; display:grid; grid-template-columns:1fr 80px; gap:10px; align-items:center;
      opacity:0; pointer-events:none; transition:opacity .18s ease,transform .18s ease; z-index:1200;
    }
    .currency-wrap:hover .currency-menu{ opacity:1; pointer-events:auto; transform: translateX(-50%) translateY(0); }
    .currency-menu select,.currency-menu input{
      height:40px; border-radius:14px; border:1px solid rgba(0,0,0,.12);
      padding:0 12px; font-size:.92rem; font-weight:900; outline:none; background:rgba(255,255,255,.98);
    }
    .currency-menu input{text-align:center}

    /* ðŸ”¥ CALENDAR STYLE */
    .flatpickr-calendar { background: #fff; border: none !important; border-radius: 18px !important; box-shadow: 0 15px 50px rgba(0,0,0,0.3) !important; font-family: 'Lexend', sans-serif !important; padding: 0 !important; overflow: hidden; width: 310px !important; }
    .flatpickr-calendar:before, .flatpickr-calendar:after { display: none !important; }
    .flatpickr-month { background: var(--primary) !important; color: #fff !important; fill: #fff !important; height: 55px !important; padding-top: 10px !important; }
    .flatpickr-current-month .flatpickr-monthDropdown-months, .flatpickr-current-month input.cur-year { color: #fff !important; font-weight: 800 !important; }
    .flatpickr-prev-month, .flatpickr-next-month { color: #fff !important; fill: #fff !important; padding-top: 10px !important; }
    .flatpickr-weekdays { background: var(--primary) !important; height: 36px !important; }
    span.flatpickr-weekday { background: var(--primary) !important; color: rgba(255,255,255,0.9) !important; font-weight: 700 !important; font-size: 0.9rem !important; }
    .flatpickr-days { padding: 5px !important; }
    .flatpickr-day { font-weight: 700 !important; color: #333 !important; border-radius: 50% !important; margin-top: 5px !important; height: 38px !important; line-height: 38px !important; border: 1px solid transparent !important; }
    .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange { background: var(--primary) !important; color: #fff !important; border-color: var(--primary) !important; box-shadow: 0 4px 12px rgba(214, 0, 28, 0.4) !important; }

    /* Invoice Wrapper */
    #invoiceWrap{
      width:100%;
      display:flex;
      justify-content:center;
      overflow:visible;
      transform-origin: top center; 
      transition: height 0.3s ease;
    }

    /* A4 Page */
    .page-a4{
      width:210mm;
      min-height:296mm;
      min-width: 793px; 
      background:#fff;
      position:relative;
      display:flex;flex-direction:column;
      box-shadow:0 10px 30px rgba(0,0,0,.30);
      padding:0;overflow:hidden;z-index:1;margin-top:0;
      transform-origin: top center;
    }

    .watermark-container{
      position:absolute;inset:0;
      display:flex;justify-content:center;align-items:center;
      z-index:0;opacity:.08;pointer-events:none;
    }
    .watermark-container img{width:75%;height:auto}
    .header,.body,.footer{position:relative;z-index:2}

    .header{
      background:rgba(255,241,241,.85);
      padding:30px 45px 15px 45px; 
      border-bottom:4px solid var(--gold);
      display:flex;justify-content:space-between;align-items:flex-start;gap:12px;
    }
    .header-left{display:flex;flex-direction:column}
    .title{
      font-family:'Lexend';font-size:4.2rem;color:var(--primary);
      margin:0;line-height:1;text-transform:uppercase;letter-spacing:2px;margin-left:20px;
    }
    .meta{margin-top:45px;display:flex;flex-direction:column;gap:12px}
    .meta-row{display:flex;align-items:center;gap:12px;font-weight:800;color:var(--dark)}
    .meta-row span{color:var(--primary);font-family:'Lexend';font-size:.9rem}
    .meta-row input{
      background:transparent;border:none;font-weight:800;font-size:1.1rem;color:var(--dark);
      width:140px;cursor:pointer;outline:none;
    }
    .logo-box img{height:250px;width:auto;margin-top:-50px}

    .body{padding:40px 45px;flex:1;display:flex;flex-direction:column}

    .grid{display:grid;grid-template-columns:.6fr 1.4fr;gap:0;margin-bottom:50px}
    .grid>div:first-child{border-right:3px solid var(--gold);padding-right:30px}
    .client-section{padding-left:30px}

    .box-title{
      color:#000;font-size:.85rem;font-weight:800;display:inline-block;
      padding-bottom:8px;margin-bottom:20px;text-transform:uppercase;letter-spacing:1px;line-height:1;
      box-shadow:inset 0 -3px 0 var(--primary);
    }
    .company-info{font-size:.95rem;line-height:1.6;color:var(--dark)}

    .input-group{display:flex;align-items:flex-start;margin-bottom:12px;border-bottom:1px dashed #ccc;padding-bottom:4px}
    .input-group label{
      font-weight:700;color:var(--dark);font-size:.85rem;min-width:145px;
      font-family:'Lexend';padding-top:5px;text-transform:uppercase;
    }
    .input-group input{
      flex:1;border:none;background:transparent;font-weight:600;font-size:.95rem;color:#000;
      padding:5px 0 5px 10px;outline:none;
    }

    .flow-box{border-bottom:1px dashed #ccc;margin-bottom:12px;padding-bottom:6px;cursor:text;display:block}
    .flow-box label{font-weight:700;color:var(--dark);font-size:.85rem;font-family:'Lexend';text-transform:uppercase;display:inline;margin-right:5px}
    .flow-content{display:inline;font-weight:600;font-size:.95rem;color:#000;outline:none;word-wrap:break-word;overflow-wrap:break-word;word-break:break-word}
    .flow-content:empty:before{content:'...';color:#aaa;font-weight:400}

    .phone-wrapper{display:flex;align-items:center;flex:1}
    .phone-select{border:none;background:transparent;font-weight:800;font-size:.9rem;color:var(--primary);cursor:pointer;margin-right:8px;outline:none}
    .phone-input{flex:1;border:none;background:transparent;font-weight:600;font-size:.95rem;color:#000;outline:none;padding:5px 0 5px 10px}

    table{width:100%;border-collapse:collapse;margin-top:20px}
    th{
      text-align:left;padding:12px 8px;color:var(--primary);
      font-family:'Lexend';font-size:.85rem;border-bottom:none!important;
    }
    thead{position:relative}
    thead:after{content:"";position:absolute;left:0;right:0;bottom:0;height:2px;background:var(--primary)}
    td{padding:12px 8px;border-bottom:1px solid #f0f0f0}
    td input{width:100%;border:none;font-weight:700;font-size:.95rem;background:transparent;outline:none}

    .delete-btn{
      background:transparent;border:none;cursor:pointer;color:var(--primary);
      font-weight:900;font-size:1.1rem;padding:2px 6px;border-radius:6px;line-height:1;
    }
    .delete-btn:hover{background:rgba(214,0,28,.10)}

    .totals-section{display:flex;justify-content:flex-end;margin-top:40px}
    .totals-box{width:260px;background:transparent;padding:15px;border-radius:8px;border:1px solid rgba(0,0,0,.05)}
    .row{display:flex;justify-content:space-between;padding:8px 0;font-weight:700;color:#64748b;font-size:.9rem}
    .row.final{color:var(--primary);font-size:1.15rem;border-top:2px solid var(--primary);margin-top:8px;padding-top:8px;font-family:'Lexend'}

    .payment-section{margin-top:50px;display:flex;justify-content:flex-start}
    .payment-box{font-size:.9rem;color:var(--dark);background:rgba(255,241,241,.4);padding:20px;border-radius:8px;border-left:3px solid var(--gold);min-width:320px}
    .payment-title{font-family:'Lexend';font-weight:800;color:var(--primary);text-transform:uppercase;margin-bottom:8px;font-size:.95rem;display:inline-block;border-bottom:2px solid var(--gold);padding-bottom:2px}
    .payment-details{line-height:1.7;margin-top:8px}
    .bank-info{font-weight:800;color:#000;font-size:1rem}

    .footer{padding:20px 45px;border-top:2px solid var(--gold);font-size:.8rem;color:#94a3b8;display:flex;justify-content:space-between;font-weight:700;margin-top:auto;gap:10px}
    .no-print{display:block}

    /* Modal common */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:2000;display:none;align-items:center;justify-content:center;padding:18px}
    .modal-backdrop.open{display:flex}
    .modal{width:min(980px,96vw);height:min(620px,86vh);background:rgba(255,255,255,.94);border:1px solid rgba(255,255,255,.30);border-radius:22px;box-shadow:0 25px 80px rgba(0,0,0,.35);backdrop-filter:blur(14px);overflow:hidden; display: flex; flex-direction: column;}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;background:rgba(248,250,252,.85);border-bottom:1px solid rgba(15,23,42,.08);gap:10px}
    .modal-title{font-family:'Lexend';font-weight:900;color:var(--primary);font-size:1.55rem}
    .modal-search{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.9);border:1px solid rgba(148,163,184,.35);border-radius:999px;padding:10px 14px;width:min(420px,50vw)}
    .modal-search i{color:#94a3b8}
    .modal-search input{border:none;outline:none;background:transparent;width:100%;font-weight:700;font-size:.95rem}
    .modal-close{border:none;background:transparent;font-size:1.35rem;font-weight:900;cursor:pointer;color:#0f172a;width:42px;height:42px;border-radius:12px}
    .modal-close:hover{background:rgba(15,23,42,.08)}
    .modal-body{padding:18px;overflow:auto; flex: 1;}
    
    .clients-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .client-card{background:rgba(255,255,255,.92);border:1px solid rgba(148,163,184,.30);border-radius:18px;padding:16px;box-shadow:0 14px 30px rgba(0,0,0,.10);display:flex;flex-direction:column;gap:10px;min-height:170px}
    .avatar{width:46px;height:46px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Lexend';font-weight:900;color:#fff;background:var(--primary)}
    .client-name{font-family:'Lexend';font-weight:900;color:#0f172a;font-size:1.05rem}
    .client-line{display:flex;align-items:center;gap:10px;color:#64748b;font-weight:800;font-size:.92rem}
    .client-line i{color:#94a3b8;width:16px;text-align:center}
    .card-actions{margin-top:6px;display:flex;align-items:center;gap:10px}
    .choose-btn{flex:1;height:38px;border-radius:12px;border:none;background:#111827;color:#fff;font-family:'Lexend';font-weight:900;cursor:pointer}
    .trash-btn{width:42px;height:38px;border-radius:12px;border:none;cursor:pointer;background:rgba(239,68,68,.12);color:#ef4444;font-size:1.05rem}
    .empty-state{padding:30px;text-align:center;color:#64748b;font-weight:900;background:rgba(255,255,255,.7);border:1px dashed rgba(148,163,184,.5);border-radius:18px}

    /* History Table Styles */
    .history-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    .history-table th { color: var(--primary); font-family: 'Lexend'; padding: 10px; text-align: left; }
    .history-table td { background: rgba(255,255,255,0.8); padding: 14px; font-weight: 700; color: #1e293b; border-top: 1px solid rgba(0,0,0,0.05); border-bottom: 1px solid rgba(0,0,0,0.05); }
    .history-table td:first-child { border-radius: 12px 0 0 12px; border-left: 1px solid rgba(0,0,0,0.05); }
    .history-table td:last-child { border-radius: 0 12px 12px 0; border-right: 1px solid rgba(0,0,0,0.05); text-align: right; }
    .badge-date { background: #e2e8f0; color: #475569; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; }
    .btn-action-sm { padding: 6px 12px; border-radius: 8px; font-weight: 800; font-size: 0.85rem; cursor: pointer; border: none; margin-left: 5px; }
    .btn-load { background: #3b82f6; color: white; }
    .btn-del { background: #ef4444; color: white; }

    /* âœ… iPhone/Mobile Media Query */
    @media (max-width:980px){
      input,select,textarea{font-size:16px!important} 
      body {
        padding: 0 !important;
        display: block !important;
        background: #333;
        /* ðŸ”¥ AJOUT IMPORTANT : Padding extra en bas pour le scroll */
        padding-bottom: 150px !important;
        min-height: 100vh;
      }
      .sidebar{
        position:relative!important;
        top:0!important;left:0!important;
        width:100%!important;
        transform:none!important;
        margin-bottom:14px!important;
        opacity:1!important;
        animation:none!important;
        padding: 10px;
        box-sizing: border-box;
      }
      .panel {
        flex-direction: row; flex-wrap: wrap; justify-content: center;
      }
      .panel button {
        flex: 1 1 45%; min-width: 130px;
      }
      .currency-menu{
          left: 50% !important;
          transform: translateX(-50%) translateY(10px) !important;
          top: 46px !important;
          width: 280px !important;
      }
      
      #invoice {
        margin: 0 auto;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      }
    }
  </style>
</head>

<body>

  <div class="sidebar no-print">
    <div class="panel">
      <button class="btn btn-clients" id="openClients">
        <i class="fa-solid fa-users"></i> Clients
      </button>
      <button class="btn btn-history" id="openHistory">
        <i class="fa-solid fa-clock-rotate-left"></i> Historique
      </button>
      <button class="btn btn-saveinfo" id="saveClient">
        <i class="fa-solid fa-floppy-disk"></i> Sauvegarder Client
      </button>
    </div>

    <div class="currency-wrap">
      <div class="currency-fab" title="Devise & TVA">
        <div class="fab-top"><span class="fab-dot"></span><span>TVA / DEVISE</span></div>
        <div class="fab-bottom"><span id="curPreview">MAD</span> â€¢ <span id="tvaPreview">0%</span></div>
      </div>
      <div class="currency-menu">
        <select id="currency" onchange="calc(); updatePreview()">
          <option value="MAD" selected>MAD</option>
          <option value="EUR">EUR</option>
          <option value="USD">USD</option>
        </select>
        <input id="tvaRate" type="number" value="0" min="0" step="0.1" oninput="calc(); updatePreview()" />
      </div>
    </div>

    <div class="panel">
      <button class="btn btn-add" type="button" onclick="addLine()">
        <i class="fa-solid fa-plus"></i> Ajouter Ligne
      </button>
      <button class="btn btn-pdf" type="button" onclick="downloadPDF()">
        <i class="fa-solid fa-file-pdf"></i> TÃ©lÃ©charger PDF
      </button>
    </div>
  </div>

  <div class="modal-backdrop" id="clientsModalBackdrop">
    <div class="modal" role="dialog">
      <div class="modal-header">
        <div class="modal-title">Mes Clients</div>
        <div class="modal-search">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input id="clientSearch" type="text" placeholder="Chercher client..." />
        </div>
        <button class="modal-close" id="closeClients">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="clients-grid" id="clientsGrid"></div>
        <div class="empty-state" id="clientsEmpty" style="display:none;">Aucun client enregistrÃ©.</div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="historyModalBackdrop">
    <div class="modal" role="dialog">
      <div class="modal-header">
        <div class="modal-title">Historique Factures</div>
        <div class="modal-search">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input id="historySearch" type="text" placeholder="NÂ° Facture ou Client..." />
        </div>
        <button class="modal-close" id="closeHistory">Ã—</button>
      </div>
      <div class="modal-body">
        <table class="history-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>NÂ° Facture</th>
              <th>Client</th>
              <th>Total TTC</th>
              <th style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody id="historyList"></tbody>
        </table>
        <div class="empty-state" id="historyEmpty" style="display:none;">Aucune facture dans l'historique.</div>
      </div>
    </div>
  </div>

  <div id="invoiceWrap">
    <div class="page-a4" id="invoice">
      <div class="watermark-container">
        <img src="" alt="Watermark">
      </div>

      <div class="header">
        <div class="header-left">
          <h1 class="title">FACTURE</h1>
          <div class="meta">
            <div class="meta-row"><span>DATE:</span> <input type="text" id="date" placeholder="SÃ©lectionner..."></div>
            <div class="meta-row"><span>NÂ° FACTURE:</span> <input type="text" id="invoiceNum"></div>
          </div>
        </div>
        <div class="logo-box">
          <img src="" alt="Logo">
        </div>
      </div>

      <div class="body">
        <div class="grid">
          <div>
            <span class="box-title">Ã‰METTEUR</span>
            <div class="company-info">
              <strong style="color:var(--primary); font-family:'Lexend'; font-size:1.1rem;">DELICELLA SARL AU</strong><br>
              4, Rue Oued Ziz, 3Ã¨me Ã‰tage<br>Appt. 7, Agdal<br>
              +212 642-395388
            </div>
          </div>

          <div class="client-section">
            <span class="box-title">DESTINATAIRE</span>

            <div class="input-group">
              <label>Nom du client :</label>
              <input type="text" id="c_name" placeholder="...">
            </div>

            <div class="flow-box" onclick="this.querySelector('.flow-content').focus()">
              <label>SociÃ©tÃ© Nom :</label>
              <span class="flow-content" id="c_company" contenteditable="true"></span>
            </div>

            <div class="flow-box" onclick="this.querySelector('.flow-content').focus()">
              <label>ICE :</label>
              <span class="flow-content" id="c_ice" contenteditable="true"></span>
            </div>

            <div class="flow-box" onclick="this.querySelector('.flow-content').focus()">
              <label>Adresse :</label>
              <span class="flow-content" id="c_address" contenteditable="true"></span>
            </div>

            <div class="input-group">
              <label>NÂ° TÃ©lÃ©phone :</label>
              <div class="phone-wrapper">
                <select class="phone-select" id="c_phone_code">
                  <option value="+212">ðŸ‡²ðŸ‡¦ +212</option>
                  <option value="+33">ðŸ‡«ðŸ‡· +33</option>
                  <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                  <option value="+34">ðŸ‡ªðŸ‡¸ +34</option>
                  <option value="+971">ðŸ‡¦ðŸ‡ª +971</option>
                </select>
                <input class="phone-input" type="text" id="c_phone" placeholder="6 00 00 00 00">
              </div>
            </div>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th width="45%">DÃ‰SIGNATION</th>
              <th width="10%" style="text-align:center">QTÃ‰</th>
              <th width="15%" style="text-align:right">P.U</th>
              <th width="20%" style="text-align:right">TOTAL</th>
              <th width="10%" class="no-print"></th>
            </tr>
          </thead>
          <tbody id="lines"></tbody>
        </table>

        <div class="totals-section">
          <div class="totals-box">
            <div class="row"><span>TOTAL HT</span> <span id="tht">0.00</span></div>
            <div class="row"><span id="tvaLabel">TVA (0%)</span> <span id="tva">0.00</span></div>
            <div class="row final"><span>TOTAL TTC</span> <span id="ttc">0.00</span></div>
          </div>
        </div>

        <div class="payment-section">
          <div class="payment-box">
            <div class="payment-title">RÃˆGLEMENT :</div>
            <div style="margin-bottom:5px; font-size:0.8rem; font-weight:700;">Par virement bancaire :</div>
            <div class="payment-details">
              <div style="margin-bottom:4px;">Banque : <span class="bank-info" contenteditable="true">BMCE BANK</span></div>
              <div>RIB : <span class="bank-info" contenteditable="true">MA64 0118 1500 0011 2100 0094 4504</span></div>
            </div>
          </div>
        </div>

      </div>

      <div class="footer">
        <div>ICE: 003709007000096 | RC: 185955</div>
        <div>E-mail : contact@delicella.ma</div>
      </div>
    </div>
  </div>

  <datalist id="produits-list">
    <option value="SAHARA DELICE 700G">
    <option value="SAHARA DELICE 350G">
  </datalist>

  <script>
    const currencySymbols = { MAD: "DH", EUR: "â‚¬", USD: "$" };

    /* =========================
       ðŸ”¥ IPHONE/PC SCALING ðŸ”¥
       ========================= */
    function applyDesktopScale(){
      const invoice = document.getElementById("invoice");
      const wrap = document.getElementById("invoiceWrap");
      if(!invoice || !wrap) return;

      const originalWidth = 793; 
      const screenWidth = window.innerWidth;

      if(screenWidth < 980){
        // Mobile Mode
        const scale = (screenWidth - 20) / originalWidth; 
        invoice.style.transform = `scale(${scale})`;
        
        // ðŸ”¥ CALCUL CORRIGÃ‰ POUR L'ESPACE EN BAS
        const newHeight = (invoice.offsetHeight * scale);
        wrap.style.height = newHeight + "px";
        
        // ðŸ”¥ AJOUT DE MARGE EXTRA POUR LE SCROLL
        wrap.style.marginBottom = "150px"; 
      } else {
        // Desktop Mode
        invoice.style.transform = "none";
        wrap.style.height = "auto";
        wrap.style.marginBottom = "0";
      }
    }

    /* =========================
       Init
       ========================= */
    window.onload = () => {
      flatpickr("#date", { locale:"fr", dateFormat:"d/m/Y", defaultDate:"today", animate:true, disableMobile:true });
      
      // Init Facture Num if empty
      if(!document.getElementById('invoiceNum').value) {
        document.getElementById('invoiceNum').value = Math.floor(10000 + Math.random() * 90000);
      }

      addLine(); addLine();
      updatePreview();
      calc();
      applyDesktopScale();
    };

    window.addEventListener("resize", () => setTimeout(applyDesktopScale, 120));
    window.addEventListener("orientationchange", () => setTimeout(applyDesktopScale, 200));

    function updatePreview(){
      const cur = document.getElementById("currency").value || "MAD";
      const tva = parseFloat(document.getElementById("tvaRate").value);
      document.getElementById("curPreview").innerText = cur;
      // âœ… Si pas de nombre, mettre 0% au lieu de 20%
      document.getElementById("tvaPreview").innerText = (isNaN(tva) ? 0 : tva) + "%";
    }

    function getCurrencySymbol(){
      const cur = document.getElementById('currency')?.value || "MAD";
      return currencySymbols[cur] || "DH";
    }
    function getTvaRate(){
      const v = parseFloat(document.getElementById('tvaRate')?.value);
      // âœ… Si pas de nombre, mettre 0% au lieu de 20%
      return isNaN(v) ? 0 : v;
    }

    function addLine(desc="", qty=1, price="") {
      const sym = getCurrencySymbol();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" class="desc" list="produits-list" placeholder="Article ou Service..." value="${desc}"></td>
        <td><input class="qty" type="number" value="${qty}" style="text-align:center" oninput="calc()"></td>
        <td><input class="pu" type="number" placeholder="0.00" value="${price}" style="text-align:right" oninput="calc()"></td>
        <td style="text-align:right; font-weight:800; color:#1e293b">0.00 ${sym}</td>
        <td class="no-print" style="text-align:right;">
          <button class="delete-btn" type="button" onclick="removeLine(this)" title="Supprimer">âœ–</button>
        </td>
      `;
      document.getElementById('lines').appendChild(tr);
      calc();
      setTimeout(applyDesktopScale, 80);
    }

    function removeLine(btn){
      const row = btn.closest('tr');
      if(row) row.remove();
      calc();
      setTimeout(applyDesktopScale, 80);
    }

    function calc() {
      const sym = getCurrencySymbol();
      const rate = getTvaRate();
      document.getElementById('tvaLabel').innerText = `TVA (${rate}%)`;

      let total = 0;
      document.querySelectorAll('#lines tr').forEach(row => {
        const q = parseFloat(row.querySelector('.qty')?.value) || 0;
        const p = parseFloat(row.querySelector('.pu')?.value) || 0;
        const t = q * p;
        row.cells[3].innerText = t.toFixed(2) + " " + sym;
        total += t;
      });

      const tva = total * (rate / 100);
      const ttc = total + tva;

      document.getElementById('tht').innerText = total.toFixed(2) + " " + sym;
      document.getElementById('tva').innerText = tva.toFixed(2) + " " + sym;
      document.getElementById('ttc').innerText = ttc.toFixed(2) + " " + sym;
      setTimeout(applyDesktopScale, 60);
    }

    /* =========================
       ðŸ”¥ HISTORIQUE LOGIC ðŸ”¥
       ========================= */
    const HISTORY_KEY = "delicella_invoices_history_v1";

    function getHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]"); }catch{return [];} }
    function saveHistory(list){ localStorage.setItem(HISTORY_KEY, JSON.stringify(list)); }

    function saveCurrentInvoiceToHistory(){
        const num = document.getElementById('invoiceNum').value;
        if(!num) return; // Pas de num, pas de save

        const clientData = getClientFromForm();
        
        // Scrap rows
        const items = [];
        document.querySelectorAll('#lines tr').forEach(row => {
            const desc = row.querySelector('.desc')?.value || "";
            const qty = row.querySelector('.qty')?.value || 0;
            const pu = row.querySelector('.pu')?.value || 0;
            if(desc || pu) items.push({desc, qty, pu});
        });

        const invoiceData = {
            id: num,
            date: document.getElementById('date').value,
            client: clientData,
            items: items,
            settings: {
                currency: document.getElementById("currency").value,
                tva: document.getElementById("tvaRate").value
            },
            totalTTC: document.getElementById('ttc').innerText,
            savedAt: Date.now()
        };

        let list = getHistory();
        // Remove existing with same ID to update
        list = list.filter(i => i.id !== num);
        // Add to top
        list.unshift(invoiceData);
        saveHistory(list);
        toast("âœ… Facture enregistrÃ©e dans l'historique");
        renderHistory();
    }

    function loadInvoiceFromHistory(id){
        const list = getHistory();
        const inv = list.find(i => i.id === id);
        if(!inv) return;

        // Restore fields
        document.getElementById('invoiceNum').value = inv.id;
        if(document.getElementById('date') && inv.date) document.getElementById('date')._flatpickr.setDate(inv.date);
        
        // Client
        fillFormWithClient(inv.client);

        // Settings
        document.getElementById("currency").value = inv.settings.currency || "MAD";
        document.getElementById("tvaRate").value = inv.settings.tva || 0; // DÃ©faut 0 si undefined
        updatePreview();

        // Lines
        const linesTbody = document.getElementById('lines');
        linesTbody.innerHTML = ""; // Clear
        inv.items.forEach(item => {
            addLine(item.desc, item.qty, item.pu);
        });
        if(inv.items.length === 0) addLine();

        calc();
        closeHistoryModal();
        toast("ðŸ“‚ Facture chargÃ©e !");
    }

    function deleteInvoiceFromHistory(id){
        if(!confirm("Supprimer cette facture de l'historique ?")) return;
        let list = getHistory();
        list = list.filter(i => i.id !== id);
        saveHistory(list);
        renderHistory();
    }

    /* =========================
       PDF & AUTO SAVE
       ========================= */
    function downloadPDF() {
      // 1. Sauvegarder d'abord
      saveCurrentInvoiceToHistory();

      // 2. GÃ©nÃ©rer PDF
      const element = document.getElementById('invoice');
      const oldTransform = element.style.transform;
      element.style.transform = "none";

      const btn = document.querySelector('.btn-pdf');
      const oldHTML = btn.innerHTML;
      btn.innerHTML = "â³ GÃ©nÃ©ration...";

      const opt = {
        margin: 0,
        filename: `Facture_${document.getElementById('invoiceNum').value}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0, ignoreElements: (el) => el.classList?.contains('no-print') },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().from(element).set(opt).save().then(() => {
        btn.innerHTML = oldHTML;
        element.style.transform = oldTransform;
        setTimeout(applyDesktopScale, 120);
      }).catch(err => {
        alert("Erreur: " + err);
        btn.innerHTML = oldHTML;
        element.style.transform = oldTransform;
        setTimeout(applyDesktopScale, 120);
      });
    }

    /* =========================
       Modals & UI Logic
       ========================= */
    
    // -- History Modal --
    const historyModal = document.getElementById("historyModalBackdrop");
    document.getElementById("openHistory").addEventListener("click", () => {
        historyModal.classList.add("open");
        renderHistory();
    });
    document.getElementById("closeHistory").addEventListener("click", closeHistoryModal);
    function closeHistoryModal(){ historyModal.classList.remove("open"); }
    
    document.getElementById("historySearch").addEventListener("input", renderHistory);

    function renderHistory(){
        const list = getHistory();
        const q = document.getElementById("historySearch").value.toLowerCase();
        const tbody = document.getElementById("historyList");
        const empty = document.getElementById("historyEmpty");

        tbody.innerHTML = "";
        const filtered = list.filter(i => 
            i.id.toString().toLowerCase().includes(q) || 
            (i.client.name||"").toLowerCase().includes(q) || 
            (i.client.company||"").toLowerCase().includes(q)
        );

        if(filtered.length === 0){ empty.style.display = "block"; return; }
        empty.style.display = "none";

        filtered.forEach(inv => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><span class="badge-date">${inv.date}</span></td>
                <td>#${inv.id}</td>
                <td>${inv.client.company || inv.client.name || "Inconnu"}</td>
                <td style="color:var(--primary); font-weight:800;">${inv.totalTTC}</td>
                <td style="text-align:right">
                    <button class="btn-action-sm btn-load" onclick="loadInvoiceFromHistory('${inv.id}')"><i class="fa-solid fa-pen"></i></button>
                    <button class="btn-action-sm btn-del" onclick="deleteInvoiceFromHistory('${inv.id}')"><i class="fa-solid fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }


    /* =========================
       Clients Logic (Existing)
       ========================= */
    const CLIENTS_KEY = "delicella_clients_v1";

    function loadClients(){ try{ return JSON.parse(localStorage.getItem(CLIENTS_KEY) || "[]"); }catch(e){ return []; } }
    function saveClients(list){ localStorage.setItem(CLIENTS_KEY, JSON.stringify(list)); }

    function getClientFromForm(){
      const name = (document.getElementById("c_name").value || "").trim();
      const company = (document.getElementById("c_company").innerText || "").trim();
      const ice = (document.getElementById("c_ice").innerText || "").trim();
      const address = (document.getElementById("c_address").innerText || "").trim();
      const phoneCode = document.getElementById("c_phone_code").value || "+212";
      const phone = (document.getElementById("c_phone").value || "").trim();
      return { name, company, ice, address, phoneCode, phone };
    }

    function fillFormWithClient(c){
      document.getElementById("c_name").value = c.name || "";
      document.getElementById("c_company").innerText = c.company || "";
      document.getElementById("c_ice").innerText = c.ice || "";
      document.getElementById("c_address").innerText = c.address || "";
      document.getElementById("c_phone_code").value = c.phoneCode || "+212";
      document.getElementById("c_phone").value = c.phone || "";
    }

    function clientKey(c){
      return ((c.phoneCode||"") + (c.phone||"")).replace(/\s/g,"") || ((c.name||"") + "|" + (c.company||"")).toLowerCase();
    }

    function saveCurrentClient(){
      const c = getClientFromForm();
      if(!c.name && !c.company){ alert("Entrez au moins un Nom ou une SociÃ©tÃ©."); return; }
      let list = loadClients();
      const k = clientKey(c);
      const idx = list.findIndex(x => clientKey(x) === k);
      if(idx >= 0) list[idx] = { ...list[idx], ...c, updatedAt: Date.now() };
      else list.unshift({ ...c, id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()), createdAt: Date.now() });
      saveClients(list);
      renderClients();
      toast("âœ… Client sauvegardÃ©");
    }

    function deleteClient(id){
      const list = loadClients().filter(c => c.id !== id);
      saveClients(list);
      renderClients();
    }

    // Modal Clients
    const clientModal = document.getElementById("clientsModalBackdrop");
    document.getElementById("openClients").addEventListener("click", () => {
      clientModal.classList.add("open");
      renderClients();
    });
    document.getElementById("closeClients").addEventListener("click", () => clientModal.classList.remove("open"));
    document.getElementById("saveClient").addEventListener("click", saveCurrentClient);
    document.getElementById("clientSearch").addEventListener("input", renderClients);

    function renderClients(){
      const grid = document.getElementById("clientsGrid");
      const empty = document.getElementById("clientsEmpty");
      const q = (document.getElementById("clientSearch")?.value || "").trim().toLowerCase();
      const list = loadClients().filter(c => {
        if(!q) return true;
        return (`${c.name} ${c.company} ${c.address} ${c.phone}`).toLowerCase().includes(q);
      });
      grid.innerHTML = "";
      if(list.length === 0){ empty.style.display = "block"; return; }
      empty.style.display = "none";
      list.forEach(c => {
        const letter = ((c.name || c.company || "?").trim()[0] || "?").toUpperCase();
        const card = document.createElement("div");
        card.className = "client-card";
        card.innerHTML = `
          <div style="display:flex; gap:12px; align-items:center;">
            <div class="avatar">${letter}</div>
            <div style="min-width:0;">
              <div class="client-name">${escapeHtml(c.name || c.company || "Client")}</div>
              <div style="color:#94a3b8; font-weight:900; font-size:0.82rem; margin-top:2px;">${escapeHtml(c.company || "")}</div>
            </div>
          </div>
          <div class="client-line"><i class="fa-solid fa-location-dot"></i><span>${escapeHtml(c.address || "â€”")}</span></div>
          <div class="client-line"><i class="fa-solid fa-phone"></i><span>${escapeHtml(((c.phoneCode||"") + " " + (c.phone||"")).trim() || "â€”")}</span></div>
          <div class="card-actions">
            <button class="choose-btn" type="button">CHOISIR</button>
            <button class="trash-btn" type="button" title="Supprimer"><i class="fa-solid fa-trash"></i></button>
          </div>
        `;
        card.querySelector(".choose-btn").addEventListener("click", () => {
          fillFormWithClient(c);
          clientModal.classList.remove("open");
          toast("âœ… Client sÃ©lectionnÃ©");
        });
        card.querySelector(".trash-btn").addEventListener("click", () => {
          if(confirm("Supprimer ce client ?")) deleteClient(c.id);
        });
        grid.appendChild(card);
      });
    }

    function escapeHtml(str){ return String(str || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }

    let toastTimer = null;
    function toast(msg){
      let t = document.getElementById("toastBox");
      if(!t){
        t = document.createElement("div"); t.id = "toastBox";
        t.style.cssText = `position: fixed; left: 50%; bottom: 22px; transform: translateX(-50%); background: rgba(17,24,39,0.92); color: #fff; padding: 12px 16px; border-radius: 14px; font-family: 'Lexend'; font-weight: 900; font-size: 0.9rem; box-shadow: 0 18px 50px rgba(0,0,0,0.35); z-index: 5000; opacity: 0; transition: opacity .18s ease, transform .18s ease;`;
        document.body.appendChild(t);
      }
      t.textContent = msg; t.style.opacity = "1"; t.style.transform = "translateX(-50%) translateY(-2px)";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { t.style.opacity = "0"; t.style.transform = "translateX(-50%) translateY(6px)"; }, 1400);
    }
  </script>
</body>
</html>
